<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á˜áŸ’á˜áœá·á’á¸á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™ AI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checkerboard {
            background-color: #f0f0f0;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), 
                              linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-2xl p-6 md:p-8 mt-6">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-purple-700 mb-2">âœ¨ AI á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™</h1>
            <p class="text-gray-600">á•áŸ’á‘á»á€á¡á¾á„ášá¼á”á—á¶á– (JPG/PNG) áŠá¾á˜áŸ’á”á¸á”áŸ’ášá¾ AI á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™á—áŸ’á›á¶á˜áŸ—áŸ”</p>
        </header>

        <!-- Input Section -->
        <div class="space-y-4">
            <label class="block text-gray-700 font-semibold" for="file-input">áŸ¡. á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–:</label>
            <input type="file" id="file-input" accept="image/png, image/jpeg" class="w-full text-gray-700 border border-gray-300 rounded-lg p-2 focus:ring-purple-500 focus:border-purple-500" onchange="previewImage()">
            
            <div id="image-preview-container" class="mt-4 hidden border border-gray-300 rounded-xl p-3 bg-gray-50 flex justify-center">
                <img id="image-preview" class="max-h-64 object-contain rounded-lg shadow-md" alt="ášá¼á”á—á¶á–áŠá¾á˜">
            </div>

            <button id="process-button" onclick="removeBackground()" class="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition duration-200 disabled:opacity-50" disabled>
                á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™
            </button>
        </div>

        <!-- Status & Loading -->
        <div id="status-box" class="mt-6 hidden p-4 rounded-lg text-center" role="alert">
            <p id="status-text" class="font-medium"></p>
        </div>

        <!-- Result Display Area -->
        <div id="result-area" class="mt-8 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">áŸ¢. á›á‘áŸ’á’á•á›áŠáŸ‚á›á”á¶á“á€á¶ááŸ‹á…áŸá‰</h2>
            <div class="relative checkerboard w-full rounded-xl shadow-inner flex items-center justify-center p-4 min-h-[256px]">
                <img id="result-image" class="max-w-full max-h-96 object-contain rounded-lg" alt="á›á‘áŸ’á’á•á›" onerror="this.style.display='none';">
            </div>

            <!-- Download Button -->
            <div class="mt-6">
                <button id="download-button" onclick="downloadImage()" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-200 disabled:opacity-50" disabled>
                    á‘á¶á‰á™á€á›á‘áŸ’á’á•á› (PNG)
                </button>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const resultImage = document.getElementById('result-image');
        const processButton = document.getElementById('process-button');
        const downloadButton = document.getElementById('download-button');
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        const resultArea = document.getElementById('result-area');
        
        let base64ImageData = null;

        // --- Utility Functions ---
        function setStatus(message, type = 'info') {
            statusText.textContent = message;
            statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'loading') {
                statusBox.classList.add('bg-blue-100', 'text-blue-700');
            } else if (type === 'success') {
                statusBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                statusBox.classList.add('bg-red-100', 'text-red-700');
            } else { // info
                statusBox.classList.add('bg-gray-100', 'text-gray-700');
            }
            statusBox.classList.remove('hidden');
        }

        function clearResults() {
            resultArea.classList.add('hidden');
            resultImage.src = '';
            downloadButton.disabled = true;
        }

        // --- Image Handling ---

        function previewImage() {
            const file = fileInput.files[0];
            clearResults();
            base64ImageData = null;

            if (!file) {
                imagePreviewContainer.classList.add('hidden');
                processButton.disabled = true;
                setStatus("áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–...", 'info');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                processButton.disabled = false;
                
                // Extract Base64 part
                const [header, data] = e.target.result.split(',');
                if (data) {
                    base64ImageData = data;
                }
                setStatus("ášá¼á”á—á¶á–á”á¶á“á•áŸ’á‘á»á€á¡á¾á„ášá½á…ášá¶á›áŸ‹áŸ” á…á»á… 'á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™'áŸ”", 'success');
            };
            reader.readAsDataURL(file);
        }

        // --- API Integration (Background Removal) ---

        async function fetchWithRetry(url, options) {
            const MAX_RETRIES = 3;
            let lastError = null;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${i + 1} failed: ${error.message}. Retrying in ${Math.pow(2, i)}s...`);
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }
            throw new Error(`Failed to fetch after ${MAX_RETRIES} attempts: ${lastError.message}`);
        }

        async function removeBackground() {
            if (!base64ImageData) {
                setStatus("áŸá¼á˜á•áŸ’á‘á»á€á¡á¾á„ášá¼á”á—á¶á–á‡á¶á˜á»á“áŸá·á“áŸ”", 'error');
                return;
            }

            // Hide previous results
            resultArea.classList.add('hidden');
            downloadButton.disabled = true;
            setStatus("ğŸš€ á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶ášá€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™... (áŸá¼á˜ášá„áŸ‹á…á¶áŸ†á”á“áŸ’áá·á…)", 'loading');
            processButton.disabled = true;

            const userPrompt = "Remove the background from this image. The output image must only contain the foreground object/person with a completely transparent background. Do not add any new background color or context.";
            const mimeType = fileInput.files[0].type;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseModalities: ['IMAGE', 'TEXT'] 
                },
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    resultImage.src = imageUrl;
                    resultArea.classList.remove('hidden');
                    downloadButton.disabled = false;
                    setStatus("âœ… á€á¶ááŸ‹á•áŸ’á‘áŸƒáá¶á„á€áŸ’ášáŸ„á™á”á¶á“á‡áŸ„á‚á‡áŸá™! ášá¼á”á—á¶á– PNG ááŸ’á›á¶ááŸ’ášáŸ€á˜ášá½á…ášá¶á›áŸ‹áŸ”", 'success');
                } else {
                    setStatus("âŒ á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá‘á‘á½á›á”á¶á“ášá¼á”á—á¶á–á›á‘áŸ’á’á•á›á–á¸ AIáŸ” áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”", 'error');
                    console.error("AI Response Error:", result);
                }

            } catch (error) {
                setStatus(`âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá áŸ… API: ${error.message}`, 'error');
                console.error("API Call Error:", error);
            } finally {
                processButton.disabled = false;
            }
        }

        /**
         * Triggers the download of the result image.
         */
        function downloadImage() {
            if (downloadButton.disabled || !resultImage.src) return;

            const link = document.createElement('a');
            link.href = resultImage.src;
            link.download = 'ai_removed_background.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>

